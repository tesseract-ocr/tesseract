{"version":3,"sources":["../../../../src/build/webpack/plugins/telemetry-plugin.ts"],"sourcesContent":["import type { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { NormalModule } from 'next/dist/compiled/webpack/webpack'\n\n/**\n * List of target triples next-swc native binary supports.\n */\nexport type SWC_TARGET_TRIPLE =\n  | 'x86_64-apple-darwin'\n  | 'x86_64-unknown-linux-gnu'\n  | 'x86_64-pc-windows-msvc'\n  | 'i686-pc-windows-msvc'\n  | 'aarch64-unknown-linux-gnu'\n  | 'armv7-unknown-linux-gnueabihf'\n  | 'aarch64-apple-darwin'\n  | 'aarch64-linux-android'\n  | 'arm-linux-androideabi'\n  | 'x86_64-unknown-freebsd'\n  | 'x86_64-unknown-linux-musl'\n  | 'aarch64-unknown-linux-musl'\n  | 'aarch64-pc-windows-msvc'\n\nexport type Feature =\n  | 'next/image'\n  | 'next/future/image'\n  | 'next/legacy/image'\n  | 'next/script'\n  | 'next/dynamic'\n  | '@next/font/google'\n  | '@next/font/local'\n  | 'next/font/google'\n  | 'next/font/local'\n  | 'swcLoader'\n  | 'swcRelay'\n  | 'swcStyledComponents'\n  | 'swcReactRemoveProperties'\n  | 'swcExperimentalDecorators'\n  | 'swcRemoveConsole'\n  | 'swcImportSource'\n  | 'swcEmotion'\n  | `swc/target/${SWC_TARGET_TRIPLE}`\n  | 'turbotrace'\n  | 'transpilePackages'\n  | 'skipMiddlewareUrlNormalize'\n  | 'skipTrailingSlashRedirect'\n  | 'modularizeImports'\n  | 'esmExternals'\n\ninterface FeatureUsage {\n  featureName: Feature\n  invocationCount: number\n}\n\n/**\n * A vertex in the module graph.\n */\ninterface Module {\n  type: string\n  identifier(): string\n}\n\n/**\n * An edge in the module graph.\n */\ninterface Connection {\n  originModule: unknown\n}\n\n// Map of a feature module to the file it belongs in the next package.\nconst FEATURE_MODULE_MAP: ReadonlyMap<Feature, string> = new Map([\n  ['next/image', '/next/image.js'],\n  ['next/future/image', '/next/future/image.js'],\n  ['next/legacy/image', '/next/legacy/image.js'],\n  ['next/script', '/next/script.js'],\n  ['next/dynamic', '/next/dynamic.js'],\n])\nconst FEATURE_MODULE_REGEXP_MAP: ReadonlyMap<Feature, RegExp> = new Map([\n  ['@next/font/google', /\\/@next\\/font\\/google\\/target.css?.+$/],\n  ['@next/font/local', /\\/@next\\/font\\/local\\/target.css?.+$/],\n  ['next/font/google', /\\/next\\/font\\/google\\/target.css?.+$/],\n  ['next/font/local', /\\/next\\/font\\/local\\/target.css?.+$/],\n])\n\n// List of build features used in webpack configuration\nconst BUILD_FEATURES: Array<Feature> = [\n  'swcLoader',\n  'swcRelay',\n  'swcStyledComponents',\n  'swcReactRemoveProperties',\n  'swcExperimentalDecorators',\n  'swcRemoveConsole',\n  'swcImportSource',\n  'swcEmotion',\n  'swc/target/x86_64-apple-darwin',\n  'swc/target/x86_64-unknown-linux-gnu',\n  'swc/target/x86_64-pc-windows-msvc',\n  'swc/target/i686-pc-windows-msvc',\n  'swc/target/aarch64-unknown-linux-gnu',\n  'swc/target/armv7-unknown-linux-gnueabihf',\n  'swc/target/aarch64-apple-darwin',\n  'swc/target/aarch64-linux-android',\n  'swc/target/arm-linux-androideabi',\n  'swc/target/x86_64-unknown-freebsd',\n  'swc/target/x86_64-unknown-linux-musl',\n  'swc/target/aarch64-unknown-linux-musl',\n  'swc/target/aarch64-pc-windows-msvc',\n  'turbotrace',\n  'transpilePackages',\n  'skipMiddlewareUrlNormalize',\n  'skipTrailingSlashRedirect',\n  'modularizeImports',\n  'esmExternals',\n]\n\nconst eliminatedPackages = new Set<string>()\n\n/**\n * Determine if there is a feature of interest in the specified 'module'.\n */\nfunction findFeatureInModule(module: Module): Feature | undefined {\n  if (module.type !== 'javascript/auto') {\n    return\n  }\n  const normalizedIdentifier = module.identifier().replace(/\\\\/g, '/')\n  for (const [feature, path] of FEATURE_MODULE_MAP) {\n    if (normalizedIdentifier.endsWith(path)) {\n      return feature\n    }\n  }\n  for (const [feature, regexp] of FEATURE_MODULE_REGEXP_MAP) {\n    if (regexp.test(normalizedIdentifier)) {\n      return feature\n    }\n  }\n}\n\n/**\n * Find unique origin modules in the specified 'connections', which possibly\n * contains more than one connection for a module due to different types of\n * dependency.\n */\nfunction findUniqueOriginModulesInConnections(\n  connections: Connection[],\n  originModule: Module\n): Set<unknown> {\n  const originModules = new Set()\n  for (const connection of connections) {\n    if (\n      !originModules.has(connection.originModule) &&\n      connection.originModule !== originModule\n    ) {\n      originModules.add(connection.originModule)\n    }\n  }\n  return originModules\n}\n\n/**\n * Plugin that queries the ModuleGraph to look for modules that correspond to\n * certain features (e.g. next/image and next/script) and record how many times\n * they are imported.\n */\nexport class TelemetryPlugin implements webpack.WebpackPluginInstance {\n  private usageTracker: Map<Feature, FeatureUsage> = new Map<\n    Feature,\n    FeatureUsage\n  >()\n\n  // Build feature usage is on/off and is known before the build starts\n  constructor(buildFeaturesMap: Map<Feature, boolean>) {\n    for (const featureName of BUILD_FEATURES) {\n      this.usageTracker.set(featureName, {\n        featureName,\n        invocationCount: buildFeaturesMap.get(featureName) ? 1 : 0,\n      })\n    }\n\n    for (const featureName of FEATURE_MODULE_MAP.keys()) {\n      this.usageTracker.set(featureName, {\n        featureName,\n        invocationCount: 0,\n      })\n    }\n\n    for (const featureName of FEATURE_MODULE_REGEXP_MAP.keys()) {\n      this.usageTracker.set(featureName, {\n        featureName,\n        invocationCount: 0,\n      })\n    }\n  }\n\n  apply(compiler: webpack.Compiler): void {\n    compiler.hooks.make.tapAsync(\n      TelemetryPlugin.name,\n      async (compilation: webpack.Compilation, callback: () => void) => {\n        compilation.hooks.finishModules.tapAsync(\n          TelemetryPlugin.name,\n          async (modules: Iterable<Module>, modulesFinish: () => void) => {\n            for (const module of modules) {\n              const feature = findFeatureInModule(module)\n              if (!feature) {\n                continue\n              }\n              const connections = (\n                compilation as any\n              ).moduleGraph.getIncomingConnections(module)\n              const originModules = findUniqueOriginModulesInConnections(\n                connections,\n                module\n              )\n              this.usageTracker.get(feature)!.invocationCount =\n                originModules.size\n            }\n            modulesFinish()\n          }\n        )\n        callback()\n      }\n    )\n    if (compiler.options.mode === 'production' && !compiler.watchMode) {\n      compiler.hooks.compilation.tap(TelemetryPlugin.name, (compilation) => {\n        const moduleHooks = NormalModule.getCompilationHooks(compilation)\n        moduleHooks.loader.tap(TelemetryPlugin.name, (loaderContext: any) => {\n          loaderContext.eliminatedPackages = eliminatedPackages\n        })\n      })\n    }\n  }\n\n  usages(): FeatureUsage[] {\n    return [...this.usageTracker.values()]\n  }\n\n  packagesUsedInServerSideProps(): string[] {\n    return Array.from(eliminatedPackages)\n  }\n}\n\nexport type TelemetryPluginState = {\n  usages: ReturnType<TelemetryPlugin['usages']>\n  packagesUsedInServerSideProps: ReturnType<\n    TelemetryPlugin['packagesUsedInServerSideProps']\n  >\n}\n"],"names":["NormalModule","FEATURE_MODULE_MAP","Map","FEATURE_MODULE_REGEXP_MAP","BUILD_FEATURES","eliminatedPackages","Set","findFeatureInModule","module","type","normalizedIdentifier","identifier","replace","feature","path","endsWith","regexp","test","findUniqueOriginModulesInConnections","connections","originModule","originModules","connection","has","add","TelemetryPlugin","constructor","buildFeaturesMap","usageTracker","featureName","set","invocationCount","get","keys","apply","compiler","hooks","make","tapAsync","name","compilation","callback","finishModules","modules","modulesFinish","moduleGraph","getIncomingConnections","size","options","mode","watchMode","tap","moduleHooks","getCompilationHooks","loader","loaderContext","usages","values","packagesUsedInServerSideProps","Array","from"],"mappings":"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"}