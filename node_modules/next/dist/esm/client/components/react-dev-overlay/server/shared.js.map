{"version":3,"sources":["../../../../../src/client/components/react-dev-overlay/server/shared.ts"],"sourcesContent":["import type { StackFrame } from 'stacktrace-parser'\nimport type { ServerResponse } from 'http'\nimport { codeFrameColumns } from 'next/dist/compiled/babel/code-frame'\nimport isInternal, {\n  nextInternalsRe,\n  reactNodeModulesRe,\n  reactVendoredRe,\n} from '../../../../shared/lib/is-internal'\n\nexport type SourcePackage = 'react' | 'next'\n\nexport interface OriginalStackFrameResponse {\n  originalStackFrame?: (StackFrame & { ignored: boolean }) | null\n  originalCodeFrame?: string | null\n  /** We use this to group frames in the error overlay */\n  sourcePackage?: SourcePackage | null\n}\n\nconst nextMethodRe = /(^__webpack_.*|node_modules[\\\\/]next[\\\\/])/\n\n/** Given a frame, it parses which package it belongs to. */\nexport function findSourcePackage({\n  file,\n  methodName,\n}: Partial<{ file: string | null; methodName: string | null }>):\n  | SourcePackage\n  | undefined {\n  if (file) {\n    // matching React first since vendored would match under `next` too\n    if (reactVendoredRe.test(file) || reactNodeModulesRe.test(file)) {\n      return 'react'\n    } else if (nextInternalsRe.test(file)) {\n      return 'next'\n    } else if (file.startsWith('[turbopack]/')) {\n      return 'next'\n    }\n  }\n\n  if (methodName) {\n    if (nextMethodRe.test(methodName)) {\n      return 'next'\n    }\n  }\n}\n\n/**\n * It looks up the code frame of the traced source.\n * @note It ignores Next.js/React internals, as these can often be huge bundled files.\n */\nexport function getOriginalCodeFrame(\n  frame: StackFrame,\n  source: string | null\n): string | null {\n  if (!source || isInternal(frame.file)) {\n    return null\n  }\n\n  return codeFrameColumns(\n    source,\n    {\n      start: {\n        // 1-based, but -1 means start line without highlighting\n        line: frame.lineNumber ?? -1,\n        // 1-based, but 0 means whole line without column highlighting\n        column: frame.column ?? 0,\n      },\n    },\n    { forceColor: process.stdout.isTTY }\n  )\n}\n\nexport function noContent(res: ServerResponse) {\n  res.statusCode = 204\n  res.end('No Content')\n}\n\nexport function badRequest(res: ServerResponse) {\n  res.statusCode = 400\n  res.end('Bad Request')\n}\n\nexport function internalServerError(res: ServerResponse, e?: any) {\n  res.statusCode = 500\n  res.end(e ?? 'Internal Server Error')\n}\n\nexport function json(res: ServerResponse, data: any) {\n  res\n    .setHeader('Content-Type', 'application/json')\n    .end(Buffer.from(JSON.stringify(data)))\n}\n\nexport function jsonString(res: ServerResponse, data: string) {\n  res.setHeader('Content-Type', 'application/json').end(Buffer.from(data))\n}\n"],"names":["codeFrameColumns","isInternal","nextInternalsRe","reactNodeModulesRe","reactVendoredRe","nextMethodRe","findSourcePackage","file","methodName","test","startsWith","getOriginalCodeFrame","frame","source","start","line","lineNumber","column","forceColor","process","stdout","isTTY","noContent","res","statusCode","end","badRequest","internalServerError","e","json","data","setHeader","Buffer","from","JSON","stringify","jsonString"],"mappings":"AAEA,SAASA,gBAAgB,QAAQ,sCAAqC;AACtE,OAAOC,cACLC,eAAe,EACfC,kBAAkB,EAClBC,eAAe,QACV,qCAAoC;AAW3C,MAAMC,eAAe;AAErB,0DAA0D,GAC1D,OAAO,SAASC,kBAAkB,KAG4B;IAH5B,IAAA,EAChCC,IAAI,EACJC,UAAU,EACkD,GAH5B;IAMhC,IAAID,MAAM;QACR,mEAAmE;QACnE,IAAIH,gBAAgBK,IAAI,CAACF,SAASJ,mBAAmBM,IAAI,CAACF,OAAO;YAC/D,OAAO;QACT,OAAO,IAAIL,gBAAgBO,IAAI,CAACF,OAAO;YACrC,OAAO;QACT,OAAO,IAAIA,KAAKG,UAAU,CAAC,iBAAiB;YAC1C,OAAO;QACT;IACF;IAEA,IAAIF,YAAY;QACd,IAAIH,aAAaI,IAAI,CAACD,aAAa;YACjC,OAAO;QACT;IACF;AACF;AAEA;;;CAGC,GACD,OAAO,SAASG,qBACdC,KAAiB,EACjBC,MAAqB;IAErB,IAAI,CAACA,UAAUZ,WAAWW,MAAML,IAAI,GAAG;QACrC,OAAO;IACT;QAOYK,mBAEEA;IAPd,OAAOZ,iBACLa,QACA;QACEC,OAAO;YACL,wDAAwD;YACxDC,MAAMH,CAAAA,oBAAAA,MAAMI,UAAU,YAAhBJ,oBAAoB,CAAC;YAC3B,8DAA8D;YAC9DK,QAAQL,CAAAA,gBAAAA,MAAMK,MAAM,YAAZL,gBAAgB;QAC1B;IACF,GACA;QAAEM,YAAYC,QAAQC,MAAM,CAACC,KAAK;IAAC;AAEvC;AAEA,OAAO,SAASC,UAAUC,GAAmB;IAC3CA,IAAIC,UAAU,GAAG;IACjBD,IAAIE,GAAG,CAAC;AACV;AAEA,OAAO,SAASC,WAAWH,GAAmB;IAC5CA,IAAIC,UAAU,GAAG;IACjBD,IAAIE,GAAG,CAAC;AACV;AAEA,OAAO,SAASE,oBAAoBJ,GAAmB,EAAEK,CAAO;IAC9DL,IAAIC,UAAU,GAAG;IACjBD,IAAIE,GAAG,CAACG,YAAAA,IAAK;AACf;AAEA,OAAO,SAASC,KAAKN,GAAmB,EAAEO,IAAS;IACjDP,IACGQ,SAAS,CAAC,gBAAgB,oBAC1BN,GAAG,CAACO,OAAOC,IAAI,CAACC,KAAKC,SAAS,CAACL;AACpC;AAEA,OAAO,SAASM,WAAWb,GAAmB,EAAEO,IAAY;IAC1DP,IAAIQ,SAAS,CAAC,gBAAgB,oBAAoBN,GAAG,CAACO,OAAOC,IAAI,CAACH;AACpE"}