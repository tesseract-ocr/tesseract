{"version":3,"sources":["../../src/server/utils.ts"],"sourcesContent":["import { BLOCKED_PAGES } from '../shared/lib/constants'\n\nexport function isBlockedPage(page: string): boolean {\n  return BLOCKED_PAGES.includes(page)\n}\n\nexport function cleanAmpPath(pathname: string): string {\n  if (pathname.match(/\\?amp=(y|yes|true|1)/)) {\n    pathname = pathname.replace(/\\?amp=(y|yes|true|1)&?/, '?')\n  }\n  if (pathname.match(/&amp=(y|yes|true|1)/)) {\n    pathname = pathname.replace(/&amp=(y|yes|true|1)/, '')\n  }\n  pathname = pathname.replace(/\\?$/, '')\n  return pathname\n}\n\ntype AnyFunc<T> = (this: T, ...args: any) => any\nexport function debounce<T, F extends AnyFunc<T>>(\n  fn: F,\n  ms: number,\n  maxWait = Infinity\n) {\n  let timeoutId: undefined | NodeJS.Timeout\n\n  // The time the debouncing function was first called during this debounce queue.\n  let startTime = 0\n  // The time the debouncing function was last called.\n  let lastCall = 0\n\n  // The arguments and this context of the last call to the debouncing function.\n  let args: Parameters<F>, context: T\n\n  // A helper used to that either invokes the debounced function, or\n  // reschedules the timer if a more recent call was made.\n  function run() {\n    const now = Date.now()\n    const diff = lastCall + ms - now\n\n    // If the diff is non-positive, then we've waited at least `ms`\n    // milliseconds since the last call. Or if we've waited for longer than the\n    // max wait time, we must call the debounced function.\n    if (diff <= 0 || startTime + maxWait >= now) {\n      // It's important to clear the timeout id before invoking the debounced\n      // function, in case the function calls the debouncing function again.\n      timeoutId = undefined\n      fn.apply(context, args)\n    } else {\n      // Else, a new call was made after the original timer was scheduled. We\n      // didn't clear the timeout (doing so is very slow), so now we need to\n      // reschedule the timer for the time difference.\n      timeoutId = setTimeout(run, diff)\n    }\n  }\n\n  return function (this: T, ...passedArgs: Parameters<F>) {\n    // The arguments and this context of the most recent call are saved so the\n    // debounced function can be invoked with them later.\n    args = passedArgs\n    context = this\n\n    // Instead of constantly clearing and scheduling a timer, we record the\n    // time of the last call. If a second call comes in before the timer fires,\n    // then we'll reschedule in the run function. Doing this is considerably\n    // faster.\n    lastCall = Date.now()\n\n    // Only schedule a new timer if we're not currently waiting.\n    if (timeoutId === undefined) {\n      startTime = lastCall\n      timeoutId = setTimeout(run, ms)\n    }\n  }\n}\n"],"names":["cleanAmpPath","debounce","isBlockedPage","page","BLOCKED_PAGES","includes","pathname","match","replace","fn","ms","maxWait","Infinity","timeoutId","startTime","lastCall","args","context","run","now","Date","diff","undefined","apply","setTimeout","passedArgs"],"mappings":";;;;;;;;;;;;;;;;IAMgBA,YAAY;eAAZA;;IAYAC,QAAQ;eAARA;;IAhBAC,aAAa;eAAbA;;;2BAFc;AAEvB,SAASA,cAAcC,IAAY;IACxC,OAAOC,wBAAa,CAACC,QAAQ,CAACF;AAChC;AAEO,SAASH,aAAaM,QAAgB;IAC3C,IAAIA,SAASC,KAAK,CAAC,yBAAyB;QAC1CD,WAAWA,SAASE,OAAO,CAAC,0BAA0B;IACxD;IACA,IAAIF,SAASC,KAAK,CAAC,wBAAwB;QACzCD,WAAWA,SAASE,OAAO,CAAC,uBAAuB;IACrD;IACAF,WAAWA,SAASE,OAAO,CAAC,OAAO;IACnC,OAAOF;AACT;AAGO,SAASL,SACdQ,EAAK,EACLC,EAAU,EACVC,UAAUC,QAAQ;IAElB,IAAIC;IAEJ,gFAAgF;IAChF,IAAIC,YAAY;IAChB,oDAAoD;IACpD,IAAIC,WAAW;IAEf,8EAA8E;IAC9E,IAAIC,MAAqBC;IAEzB,kEAAkE;IAClE,wDAAwD;IACxD,SAASC;QACP,MAAMC,MAAMC,KAAKD,GAAG;QACpB,MAAME,OAAON,WAAWL,KAAKS;QAE7B,+DAA+D;QAC/D,2EAA2E;QAC3E,sDAAsD;QACtD,IAAIE,QAAQ,KAAKP,YAAYH,WAAWQ,KAAK;YAC3C,uEAAuE;YACvE,sEAAsE;YACtEN,YAAYS;YACZb,GAAGc,KAAK,CAACN,SAASD;QACpB,OAAO;YACL,uEAAuE;YACvE,sEAAsE;YACtE,gDAAgD;YAChDH,YAAYW,WAAWN,KAAKG;QAC9B;IACF;IAEA,OAAO,SAAmB,GAAGI,UAAyB;QACpD,0EAA0E;QAC1E,qDAAqD;QACrDT,OAAOS;QACPR,UAAU,IAAI;QAEd,uEAAuE;QACvE,2EAA2E;QAC3E,wEAAwE;QACxE,UAAU;QACVF,WAAWK,KAAKD,GAAG;QAEnB,4DAA4D;QAC5D,IAAIN,cAAcS,WAAW;YAC3BR,YAAYC;YACZF,YAAYW,WAAWN,KAAKR;QAC9B;IACF;AACF"}