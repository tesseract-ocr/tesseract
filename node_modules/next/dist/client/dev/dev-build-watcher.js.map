{"version":3,"sources":["../../../src/client/dev/dev-build-watcher.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-use-before-define */\nimport { HMR_ACTIONS_SENT_TO_BROWSER } from '../../server/dev/hot-reloader-types'\nimport type { HMR_ACTION_TYPES } from '../../server/dev/hot-reloader-types'\nimport { addMessageListener } from '../components/react-dev-overlay/pages/websocket'\n\ntype VerticalPosition = 'top' | 'bottom'\ntype HorizonalPosition = 'left' | 'right'\n\nexport interface ShowHideHandler {\n  show: () => void\n  hide: () => void\n}\n\nexport default function initializeBuildWatcher(\n  toggleCallback: (handlers: ShowHideHandler) => void,\n  position = 'bottom-right'\n) {\n  const shadowHost = document.createElement('div')\n  const [verticalProperty, horizontalProperty] = position.split('-', 2) as [\n    VerticalPosition,\n    HorizonalPosition,\n  ]\n  shadowHost.id = '__next-build-watcher'\n  // Make sure container is fixed and on a high zIndex so it shows\n  shadowHost.style.position = 'fixed'\n  // Ensure container's position to be top or bottom (default)\n  shadowHost.style[verticalProperty] = '10px'\n  // Ensure container's position to be left or right (default)\n  shadowHost.style[horizontalProperty] = '20px'\n  shadowHost.style.width = '0'\n  shadowHost.style.height = '0'\n  shadowHost.style.zIndex = '99999'\n  document.body.appendChild(shadowHost)\n\n  let shadowRoot\n  let prefix = ''\n\n  if (shadowHost.attachShadow) {\n    shadowRoot = shadowHost.attachShadow({ mode: 'open' })\n  } else {\n    // If attachShadow is undefined then the browser does not support\n    // the Shadow DOM, we need to prefix all the names so there\n    // will be no conflicts\n    shadowRoot = shadowHost\n    prefix = '__next-build-watcher-'\n  }\n\n  // Container\n  const container = createContainer(prefix)\n  shadowRoot.appendChild(container)\n\n  // CSS\n  const css = createCss(prefix, { horizontalProperty, verticalProperty })\n  shadowRoot.appendChild(css)\n\n  // State\n  let isVisible = false\n  let isBuilding = false\n  let timeoutId: null | ReturnType<typeof setTimeout> = null\n\n  // Handle events\n\n  addMessageListener((obj) => {\n    try {\n      handleMessage(obj)\n    } catch {}\n  })\n\n  function show() {\n    timeoutId && clearTimeout(timeoutId)\n    isVisible = true\n    isBuilding = true\n    updateContainer()\n  }\n\n  function hide() {\n    isBuilding = false\n    // Wait for the fade out transition to complete\n    timeoutId = setTimeout(() => {\n      isVisible = false\n      updateContainer()\n    }, 100)\n    updateContainer()\n  }\n\n  function handleMessage(obj: HMR_ACTION_TYPES) {\n    if (!('action' in obj)) {\n      return\n    }\n\n    // eslint-disable-next-line default-case\n    switch (obj.action) {\n      case HMR_ACTIONS_SENT_TO_BROWSER.BUILDING:\n        show()\n        break\n      case HMR_ACTIONS_SENT_TO_BROWSER.BUILT:\n      case HMR_ACTIONS_SENT_TO_BROWSER.SYNC:\n        hide()\n        break\n    }\n  }\n\n  toggleCallback({\n    show,\n    hide,\n  })\n\n  function updateContainer() {\n    if (isBuilding) {\n      container.classList.add(`${prefix}building`)\n    } else {\n      container.classList.remove(`${prefix}building`)\n    }\n\n    if (isVisible) {\n      container.classList.add(`${prefix}visible`)\n    } else {\n      container.classList.remove(`${prefix}visible`)\n    }\n  }\n}\n\nfunction createContainer(prefix: string) {\n  const container = document.createElement('div')\n  container.id = `${prefix}container`\n  container.innerHTML = `\n    <div id=\"${prefix}icon-wrapper\">\n      <svg viewBox=\"0 0 226 200\">\n        <defs>\n          <linearGradient\n            x1=\"114.720775%\"\n            y1=\"181.283245%\"\n            x2=\"39.5399306%\"\n            y2=\"100%\"\n            id=\"${prefix}linear-gradient\"\n          >\n            <stop stop-color=\"#000000\" offset=\"0%\" />\n            <stop stop-color=\"#FFFFFF\" offset=\"100%\" />\n          </linearGradient>\n        </defs>\n        <g id=\"${prefix}icon-group\" fill=\"none\" stroke=\"url(#${prefix}linear-gradient)\" stroke-width=\"18\">\n          <path d=\"M113,5.08219117 L4.28393801,197.5 L221.716062,197.5 L113,5.08219117 Z\" />\n        </g>\n      </svg>\n    </div>\n  `\n\n  return container\n}\n\nfunction createCss(\n  prefix: string,\n  {\n    horizontalProperty,\n    verticalProperty,\n  }: { horizontalProperty: string; verticalProperty: string }\n) {\n  const css = document.createElement('style')\n  css.textContent = `\n    #${prefix}container {\n      position: absolute;\n      ${verticalProperty}: 10px;\n      ${horizontalProperty}: 30px;\n\n      border-radius: 3px;\n      background: #000;\n      color: #fff;\n      font: initial;\n      cursor: initial;\n      letter-spacing: initial;\n      text-shadow: initial;\n      text-transform: initial;\n      visibility: initial;\n\n      padding: 7px 10px 8px 10px;\n      align-items: center;\n      box-shadow: 0 11px 40px 0 rgba(0, 0, 0, 0.25), 0 2px 10px 0 rgba(0, 0, 0, 0.12);\n\n      display: none;\n      opacity: 0;\n      transition: opacity 0.1s ease, ${verticalProperty} 0.1s ease;\n      animation: ${prefix}fade-in 0.1s ease-in-out;\n    }\n\n    #${prefix}container.${prefix}visible {\n      display: flex;\n    }\n\n    #${prefix}container.${prefix}building {\n      ${verticalProperty}: 20px;\n      opacity: 1;\n    }\n\n    #${prefix}icon-wrapper {\n      width: 16px;\n      height: 16px;\n    }\n\n    #${prefix}icon-wrapper > svg {\n      width: 100%;\n      height: 100%;\n    }\n\n    #${prefix}icon-group {\n      animation: ${prefix}strokedash 1s ease-in-out both infinite;\n    }\n\n    @keyframes ${prefix}fade-in {\n      from {\n        ${verticalProperty}: 10px;\n        opacity: 0;\n      }\n      to {\n        ${verticalProperty}: 20px;\n        opacity: 1;\n      }\n    }\n\n    @keyframes ${prefix}strokedash {\n      0% {\n        stroke-dasharray: 0 226;\n      }\n      80%,\n      100% {\n        stroke-dasharray: 659 226;\n      }\n    }\n  `\n\n  return css\n}\n"],"names":["initializeBuildWatcher","toggleCallback","position","shadowHost","document","createElement","verticalProperty","horizontalProperty","split","id","style","width","height","zIndex","body","appendChild","shadowRoot","prefix","attachShadow","mode","container","createContainer","css","createCss","isVisible","isBuilding","timeoutId","addMessageListener","obj","handleMessage","show","clearTimeout","updateContainer","hide","setTimeout","action","HMR_ACTIONS_SENT_TO_BROWSER","BUILDING","BUILT","SYNC","classList","add","remove","innerHTML","textContent"],"mappings":"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"}